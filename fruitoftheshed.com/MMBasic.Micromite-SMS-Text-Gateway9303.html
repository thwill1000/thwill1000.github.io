

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html dir="ltr" xmlns="http://www.w3.org/1999/xhtml">

<!-- Mirrored from fruitoftheshed.com/MMBasic.Micromite-SMS-Text-Gateway.ashx?HL=mmbasic by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 09 Feb 2022 14:29:28 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=8" /><title>
	SMS (Text) Gateway with MicroMite  - Fruit Of The Shed
</title><script type="text/javascript" src="JS/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="JS/Scripts.js"></script>
<script type="text/javascript" src="JS/SearchHighlight.js"></script>
<link rel="stylesheet" media="print" href="Themes/Default/Print_Styles.css" type="text/css" />
<link rel="stylesheet" media="screen" href="Themes/Default/Screen_Styles%20-%20Copy.css" type="text/css" />
<link rel="stylesheet" media="screen" href="Themes/Default/Screen_Styles.css" type="text/css" />
<link rel="stylesheet" href="Themes/Editor.css" type="text/css" />
<link rel="search" href="searchf7b1.xml?OpenSearch=1" type="application/opensearchdescription+xml" title="Fruit Of The Shed - Search" /><script src="Themes/Default/Scripts.js" type="text/javascript"></script>
<link rel="shortcut icon" href="Themes/Default/Icon.ico" type="image/x-icon" />
</head>
<body>
    <form name="aspnetForm" method="post" action="http://fruitoftheshed.com/Default.aspx?Page=Micromite-SMS-Text-Gateway&amp;NS=MMBasic&amp;HL=mmbasic" id="aspnetForm">
<div>
<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="/wEPDwUJMTQ3NjA4MDI2D2QWAmYPZBYCAgEPZBYCAgkPZBYEAhsPDxYCHg1BbnRoZW1WaXNpYmxlaGRkAicPDxYCHgdWaXNpYmxlaGQWAmYPFgIeC18hSXRlbUNvdW50ZmRkL9X+pH8J+jB1IIJZx71WjgOrjyw=" />
</div>

<script type="text/javascript">
//<![CDATA[
var Anthem_FormID = "aspnetForm";
//]]>
</script>
<script src="WebResource3c0c.axd?d=wu8PDPV1hmKciPrhUAi9NEjQUBbOefrIXCaRPwGH8Q5jrvPZFuGbKmycL3GXDKGD1_JZ083oQl1Kpd_P7rg1V93MtYOS3Vb-0Eztmu5VDCWQxc7l0&amp;t=636158881040000000" type="text/javascript"></script>
<div>

	<input type="hidden" name="__VIEWSTATEGENERATOR" id="__VIEWSTATEGENERATOR" value="CA0B0334" />
</div>
		<script type="text/javascript">
<!--
__BaseName = "ctl00_CphMaster_";
__ConfirmMessage = "Are you sure you want to proceed?";
// -->
</script>
		<script type="text/javascript">
		<!--
			function __GetServerElementById(id) {
				return document.getElementById(__BaseName + id);
			}
			function __RequestConfirm() {
				return confirm(__ConfirmMessage);
			}
		// -->
		</script>
    
        <div id="HeaderDiv">
            <div style="float: right;">Welcome <a href="MMBasic.Language.html" class="systemlink" title="Select your language">Guest</a>, you are in: <select class="namespacedropdown" onchange="javascript:var sel = this.value; document.location = (sel != '' ? (sel + '.') : '') + 'Default.aspx';"><option value="">&lt;root&gt;</option><option value="Circuit Ideas">Circuit Ideas</option><option value="Colour MaxiMite 2 (CMM2)">Colour MaxiMite 2 (CMM2)</option><option value="GCB">GCB</option><option value="MicroMite ArmMite and MMX Hardware">MicroMite ArmMite and MMX Hardware</option><option selected="selected" value="MMBasic">MMBasic</option><option value="PIC ASM">PIC ASM</option><option value="Platform Agnostic">Platform Agnostic</option></select> &bull; <a href="MMBasic.Login2e9f-2.html?Redirect=http%3a%2f%2ffruitoftheshed.com%2fDefault.aspx%3fPage%3dMicromite-SMS-Text-Gateway%26NS%3dMMBasic%26HL%3dmmbasic" class="systemlink" title="Login">Login</a></div><h1>Fruit Of The Shed</h1>
        </div>
                   
        <div id="ContainerDiv">
                 
            <div id="SidebarDiv">
                <div id="SidebarHeaderDiv">
                    <!-- Used for layout purposes only -->
                </div>
                <div id="SidebarContentDiv">
                    <div style="float: right;"> </div><h3 class="separator">Navigation (MMBasic)<a class="headeranchor" id="Navigation_NAMESPACE_0" href="#Navigation_NAMESPACE_0" title="Link to this Section">&#0182;</a></h3><ul><li><b><a class="pagelink" href="MMBasic.MainPage.html" title="_MMBasic Code Library">Main Page</a></b></li><li><a class="pagelink" href="MainPage.html" title="Home Page">Main Page (root)</a><br /></li></ul><br /><ul><li><a class="systemlink" href="MMBasic.EggDrop-part-of-the-original-MMBasic-libraryc674.html" title="Random Page">Random Page</a></li><li><a class="systemlink" href="MMBasic.AllPages.html" title="All Pages">All Pages</a><br /> </li><li><a class="systemlink" href="Logina75d.html" title="Create a new Page">Create a new Page</a><br /></li></ul><br /><ul><li><a class="systemlink" href="Logine894.html" title="Administration">Administration</a></li><li><a class="systemlink" href="MMBasic.Upload.html" title="File Management">File Management</a><br /></li></ul><br /><ul><li><a class="systemlink" href="MMBasic.Register.html" title="My Account">My Account</a><br /></li></ul><br /><ul><li><a class="systemlink" href="MMBasic.Register.html" title="Create Account">Create Account</a><br /></li></ul><br /><small><b>Search the wiki</b></small><br /><br /><script type="text/javascript"><!--
function _DoSearch_SBa925f7376d16452eba58fcd259b58efc() { document.location = 'MMBasic.Search.aspx?AllNamespaces=1&FilesAndAttachments=1&Query=' + encodeURI(document.getElementById('SBa925f7376d16452eba58fcd259b58efc').value); }
// -->
</script><input class="txtsearchbox" type="text" id="SBa925f7376d16452eba58fcd259b58efc" onkeydown="javascript:var keycode; if(window.event) keycode = event.keyCode; else keycode = event.which; if(keycode == 10 || keycode == 13) { _DoSearch_SBa925f7376d16452eba58fcd259b58efc(); return false; }" /> <big><a href="#" onclick="javascript:_DoSearch_SBa925f7376d16452eba58fcd259b58efc(); return false;">&raquo;</a></big><br /><br /><br />
                </div>
                <div id="SidebarFooterDiv">
                    <!-- Used for layout purposes only -->
                </div>
            </div>
            <div id="MainDiv">
                <div id="MainHeaderDiv">
                    <!-- Used for layout purposes only -->
                </div>
                <div id="PageInternalHeaderDiv"></div>
                

    <script type="text/javascript">
    <!--
        function __ShowAllTrail() {
            try {
                document.getElementById("BreadcrumbsDivMin").style["display"] = "none";
                document.getElementById("BreadcrumbsDivAll").style["display"] = "";
                __SetStatus("1");
            }
            catch(ex) { }
            return false;
        }
        function __HideTrail() {
            try {
                document.getElementById("BreadcrumbsDivMin").style["display"] = "";
                document.getElementById("BreadcrumbsDivAll").style["display"] = "none";
                __SetStatus("0");
            }
            catch(ex) { }
            return false;
        }
        
        function __SetStatus(open) {
            __CreateCookie("ScrewTurnWikiBCT", open, 365);
        }
        function __GetStatus() {
            var value = __ReadCookie("ScrewTurnWikiBCT");
            if(value) return value;
            else return "0";
        }

        function __InitBCT() {
        	if(__GetStatus() == "1") {
        		__ShowAllTrail();
        	}
        }

        var __attachmentsMenuJustShown = false;
        var __adminToolsMenuJustShown = false;
        var __ie7Mode = false;

        function __ToggleAttachmentsMenu(cx, cy) {
        	var element = document.getElementById("PageAttachmentsDiv");
        	if(element) {
        		if(element.style["display"] == "none") {
        			element.style["display"] = "";
        			var pos = __AbsolutePosition(element);
        			if(pos.left - cx > 0) {
        				__ie7Mode = true;
        				element.style["position"] = "absolute";
        				element.style["top"] = cy + "px";
        				element.style["left"] = (cx - pos.width) + "px";
        			}
        			else {
        				__RepositionDiv(document.getElementById("PageAttachmentsLink"), element);
        			}
        			__attachmentsMenuJustShown = true;
        		}
        	}
        	return false;
        }
        function __HideAttachmentsMenu() {
        	var element = document.getElementById("PageAttachmentsDiv");
        	if(element && !__attachmentsMenuJustShown) {
        		element.style["display"] = "none";
        		if (__ie7Mode) element.style["left"] = "10000px";
        	}
        	__attachmentsMenuJustShown = false;
        	return true; // Needed to enabled next clicks' action (file download)
        }

        function __ToggleAdminToolsMenu(cx, cy) {
        	var element = document.getElementById("AdminToolsDiv");
        	if(element) {
        		if(element.style["display"] == "none") {
        			element.style["display"] = "";
        			var pos = __AbsolutePosition(element);
        			if(pos.left - cx > 0) {
        				__ie7Mode = true;
        				element.style["position"] = "absolute";
        				element.style["top"] = cy + "px";
        				element.style["left"] = (cx - pos.width) + "px";
        			}
        			else {
        				__RepositionDiv(document.getElementById("AdminToolsLink"), element);
        			}
        			__adminToolsMenuJustShown = true;
        		}
        	}
        	return false;
        }
        function __HideAdminToolsMenu() {
        	var element = document.getElementById("AdminToolsDiv");
        	if(element && !__adminToolsMenuJustShown) {
        		element.style["display"] = "none";
        		if(__ie7Mode) element.style["left"] = "10000px";
        	}
        	__adminToolsMenuJustShown = false;
        	return true; // Needed to enable next clicks' action (admin tools)
        }

        function __HideAllMenus() {
        	__HideAttachmentsMenu();
        	__HideAdminToolsMenu();
        }

        document.body.onclick = __HideAllMenus;

        function __AbsolutePosition(obj) {
        	var pos = null;
        	if(obj != null) {
        		pos = new Object();
        		pos.top = obj.offsetTop;
        		pos.left = obj.offsetLeft;
        		pos.width = obj.offsetWidth;
        		pos.height = obj.offsetHeight;

        		obj = obj.offsetParent;
        		while(obj != null) {
        			pos.top += obj.offsetTop;
        			pos.left += obj.offsetLeft;
        			obj = obj.offsetParent;
        		}
        	}
        	return pos;
        }

        var __showTimer = null;
        var __hideTimer = null;

        function __ShowDropDown(e, divId, parent) {
           	// Set a timer
        	// On mouse out, cancel the timer and start a 2nd timer that hides the menu
        	// When the 1st timer elapses
        	//   show the drop-down
        	//   on menu mouseover, cancel the 2nd timer
        	//   on menu mouse out, hide the menu
        	__showTimer = setTimeout('__ShowDropDownForReal(' + e.clientX + ', ' + e.clientY + ', "' + divId + '", "' + parent.id + '");', 200);
        }

        function __ShowDropDownForReal(cx, cy, divId, parentId) {
        	var pos = __AbsolutePosition(document.getElementById(parentId));
        	var menu = document.getElementById(divId);

			// This is needed to trick IE7 which, for some reason,
			// does not position the drop-down correctly with the new Default theme
        	if(pos.left - cx > 30) {
        		menu.style["display"] = "";
        		menu.style["position"] = "absolute";
        		menu.style["top"] = cy + "px";
        		menu.style["left"] = (cx - 10) + "px";
        	}
        	else {
        		menu.style["display"] = "";
        		menu.style["position"] = "absolute";
        		menu.style["top"] = (pos.top + pos.height) + "px";
        		menu.style["left"] = pos.left + "px";
        	}
        	__showTimer = null;
        }

        function __HideDropDown(divId) {
        	if(__showTimer) clearTimeout(__showTimer);
        	__hideTimer = setTimeout('__HideDropDownForReal("' + divId + '");', 200);
        }

        function __HideDropDownForReal(divId) {
        	document.getElementById(divId).style["display"] = "none";
        	__hideTimer = null;
        }

        function __CancelHideTimer() {
        	if(__hideTimer) clearTimeout(__hideTimer);
        }
        
    // -->
    </script>

	<a id="PageTop"></a>
	
	<div id="PageHeaderDiv">
	
		<!-- Change this to PageToolbarDiv -->
		<div id="EditHistoryLinkDiv">
			<a id="DiscussLink" title="Discuss" href="MMBasic.Micromite-SMS-Text-Gateway266d.html?Discuss=1">Discuss (0)</a>
			
			
			<a id="HistoryLink" title="View Page edit history" href="MMBasic.Historye4b6.html?Page=MMBasic.Micromite-SMS-Text-Gateway">History</a>
			
			
			
			
			
		</div>
		
		<h1 class="pagetitle">
			
			SMS (Text) Gateway with MicroMite 
			
		</h1>
		
		<div id="PrintLinkDiv">
			<a id="PrintLink" href="MMBasic.Printe4b6.html?Page=MMBasic.Micromite-SMS-Text-Gateway" title="Printer friendly version" target="_blank">Print</a>
		</div>
		
		<div id="RssLinkDiv">
			
		</div>
		
		<div id="EmailNotificationDiv">
			<span id="Anthem_ctl00_CphMaster_btnEmailNotification__"></span>
		</div>
		
		<div id="ctl00_CphMaster_pnlPageInfo">
	
			<div id="PageInfoDiv">
				<span id="ModificationSpan">
					Modified on 
					2018/03/18 07:56
				</span>
				<span id="AuthorSpan">
					 by 
					<a href="MMBasic.Userb2ec.html?Username=hendy">CaptainBoing</a>
				</span>
				<span id="NavPathsSpan">
					
				</span>
				<span id="CategoriesSpan">
					Categorized as 
					<a href="MMBasic.AllPagesc884.html?Cat=MMBasic.Communications" title="Communications">Communications</a>, <a href="MMBasic.AllPagese076.html?Cat=MMBasic.Control" title="Control">Control</a>, <a href="MMBasic.AllPages5ce5.html?Cat=MMBasic.Electronics" title="Electronics">Electronics</a>, <a href="MMBasic.AllPagesa19c.html?Cat=MMBasic.Network" title="Network">Network</a>, <a href="MMBasic.AllPages9e56.html?Cat=MMBasic.Network%20(GSM)" title="Network (GSM)">Network (GSM)</a>, <a href="MMBasic.AllPages72b8.html?Cat=MMBasic.Wifi" title="Wifi">Wifi</a>
				</span>
				
				<span id="PageDiscussionSpan">
					
					
				</span>
			</div>
		
</div>
		
		<div id="f576d1eec-7598-4a44-ae37-b4c80b7d31e0" style="display: none;" class="pageoutgoinglinksmenu" onmouseover="javascript:return __CancelHideTimer();" onmouseout="javascript:return __HideDropDown('f576d1eec-7598-4a44-ae37-b4c80b7d31e0');"></div><div id="fbbf5cf50-5a36-4cce-8bf7-2512bbbf5aae" style="display: none;" class="pageoutgoinglinksmenu" onmouseover="javascript:return __CancelHideTimer();" onmouseout="javascript:return __HideDropDown('fbbf5cf50-5a36-4cce-8bf7-2512bbbf5aae');"></div><div id="f8bca386d-59c0-4205-a3cf-36c896f44939" style="display: none;" class="pageoutgoinglinksmenu" onmouseover="javascript:return __CancelHideTimer();" onmouseout="javascript:return __HideDropDown('f8bca386d-59c0-4205-a3cf-36c896f44939');"></div><div id="fc45da5ee-418d-42cc-b08b-f46cd4931b43" style="display: none;" class="pageoutgoinglinksmenu" onmouseover="javascript:return __CancelHideTimer();" onmouseout="javascript:return __HideDropDown('fc45da5ee-418d-42cc-b08b-f46cd4931b43');"></div><div id="f1ba06e36-2b97-47b3-9233-f73923993380" style="display: none;" class="pageoutgoinglinksmenu" onmouseover="javascript:return __CancelHideTimer();" onmouseout="javascript:return __HideDropDown('f1ba06e36-2b97-47b3-9233-f73923993380');"></div><div id="fc5d2aa8f-0afe-4705-9c8a-5d8cd79b12df" style="display: none;" class="pageoutgoinglinksmenu" onmouseover="javascript:return __CancelHideTimer();" onmouseout="javascript:return __HideDropDown('fc5d2aa8f-0afe-4705-9c8a-5d8cd79b12df');"></div><div id="s6baf7f1e-1bd0-497a-a793-d8a688f22e45" style="display: none;" class="pageoutgoinglinksmenu" onmouseover="javascript:return __CancelHideTimer();" onmouseout="javascript:return __HideDropDown('s6baf7f1e-1bd0-497a-a793-d8a688f22e45');"></div><div id="BreadcrumbsDiv"><div id="BreadcrumbsDivMin"><a href="#" onclick="javascript:return __ShowAllTrail();" title="Click here to view the complete Breadcrumbs Trail">(10)</a> &raquo; <a href="Colour%20MaxiMite%202%20(CMM2).Old-firmware-announcements.html" title="Old firmware announcements (Colour MaxiMite 2 (CMM2))">Old firmware announcements (Colour MaxiMite 2 (CMM2))</a> &raquo; <a href="MMBasic.Sprite-demo-Arcade-part-of-the-original-MMBasic-library.html" title="Sprite demo: Arcade (MMBasic)">Sprite demo: Arcade (MMBasic)</a> &raquo; <b><a href="MMBasic.Micromite-SMS-Text-Gateway.html" title="SMS (Text) Gateway with MicroMite  (MMBasic)">SMS (Text) Gateway with MicroMite  (MMBasic)</a></b> </div><div id="BreadcrumbsDivAll" style="display: none;"><a href="#" onclick="javascript:return __HideTrail();" title="Click here to hide the Breadcrumbs Trail">[X]</a> &raquo; <a href="Colour%20MaxiMite%202%20(CMM2).Converting-older-MMBASIC-programs.html" title="Converting older MMBASIC programs (Colour MaxiMite 2 (CMM2))">Converting older MMBASIC programs (Colour MaxiMite 2 (CMM2))</a> &raquo; <a href="Circuit%20Ideas.7490-The-forgotten-divider.html" title="7490 The forgotten counter/divider  (Circuit Ideas)">7490 The forgotten counter/divider  (Circuit Ideas)</a> &raquo; <a href="Platform%20Agnostic.Antenna-Length-Calculator.html" title="Antenna Length Calculator (Platform Agnostic)">Antenna Length Calculator (Platform Agnostic)</a> &raquo; <a href="Platform%20Agnostic.Cell-Battery-Internal-Resistance-Calculator.html" title="Cell/Battery Internal Resistance Calculator (Platform Agnostic)">Cell/Battery Internal Resistance Calculator (Platform Agnostic)</a> &raquo; <a href="MMBasic.Backpack-Tracker-curve-tracer.html" title="Backpack Tracker curve tracer (MMBasic)">Backpack Tracker curve tracer (MMBasic)</a> &raquo; <a href="MMBasic.Measuring-RMS-algorythm-using-MMBasic.html" title="Measuring RMS (algorythm) using MMBasic (MMBasic)">Measuring RMS (algorythm) using MMBasic (MMBasic)</a> &raquo; <a href="Colour%20MaxiMite%202%20(CMM2).Image-sprite-and-font-formats.html" title="Image, sprite, and font formats (Colour MaxiMite 2 (CMM2))">Image, sprite, and font formats (Colour MaxiMite 2 (CMM2))</a> &raquo; <a href="Colour%20MaxiMite%202%20(CMM2).Old-firmware-announcements.html" title="Old firmware announcements (Colour MaxiMite 2 (CMM2))">Old firmware announcements (Colour MaxiMite 2 (CMM2))</a> &raquo; <a href="MMBasic.Sprite-demo-Arcade-part-of-the-original-MMBasic-library.html" title="Sprite demo: Arcade (MMBasic)">Sprite demo: Arcade (MMBasic)</a> &raquo; <b><a href="MMBasic.Micromite-SMS-Text-Gateway.html" title="SMS (Text) Gateway with MicroMite  (MMBasic)">SMS (Text) Gateway with MicroMite  (MMBasic)</a></b> </div></div>
		
		
	
	</div>
	
	<div id="PageContentDiv">
		Version 1.2. Lots of improvements and an easier-to-extend API parsing section. Added the console command section - not all commands work yet. Security in the code of your Wifi password, it is Base64 encoded so it is not plainly visible in the code. If you need an encoder, there's one <a class="externallink" href="http://www.logitel.co.uk/b64enc.asp" title="here" target="_blank">here</a>.<br /><br />This SMS gateway attaches to your LAN via WiFi (Want to provide wired LAN through ENC28J60 one day). It takes a SIM card for your favourite GSM operator and connects to that mobile network. It then bridges the two and permits messages to be passed between them. Security is pretty low at the moment, but firewall external access for now. <br /><br />Program-wise, there is nothing exotic about it - no CFunctions or anything, it is a good demonstration of using the building blocks in MMBasic to provide an intelligent (and for me) really useful tool that sees daily use. It represents about two months of evolving code with tears, tantrums, a few late nights and a lot of head scratching... READ THE DATASHEETS - over and over until they make sense.<br /><br />It exposes a web API allowing text messages to be sent via a web browser or any HTTP client (i.e. your own programs). These are then forwarded in real time to the GSM network. The API is multi-session and up to 5 simultaneous connections to the API are supported. Sending of SMS messages is single session but because sending is handled on the main thread it naturally pauses the parsing while a text is sent so it providing an implicit queuing system. Messages seem to take about 5 seconds-ish to actually go from the GSM module, so the real time response (i.e. confirmation from the API) is entirely do-able. My own webpage code waits for the response and parses the reply from the API.<br /><br />Inbound SMS messages are largely ignored (and deleted from the SIM) as of Version 1.1 except for the specially crafted messages from an "admin" mobile number. One activates a relay for 10 seconds, sending a message to the effect either side of the activation. and the other sends back the eight most important flags and the enclosure temperature.<br /><br />For my application, I connected a mains extension through the Normally Closed contacts of a relay module. This feeds the mains power to the PSU for my fibre router. This router suffers from mystery lockups every few months. By sending my "crafted" message, I can remotely bounce the router through a controlled 10 second power cycle from anywhere on the planet. As a frequent traveler, I have tired of trying to talk "remote hands" through the procedure, even though to me it is trivial. Used this feature recently from Madeira when my network went dark. The gateway pings out to the internet at regular intervals (I ping one of my ISPs DNS serves - be careful who you ping - they might not like it) and alerts after a set number of fails, so I might not even know I have lost connectivity but this gateway will tell me. It then confirms when the internet connectivity comes back.<br /><br />It is a bit rough round the edges, but it does it's job well.<br /><br />Future improvements:<br /><ul><li>Full 2-way messaging convergence is the long-term target with this device. Pass inbound SMS to an API (web page on &#0091;remote&#0093; server) - will use the ESP8266 in client mode and is fairly straightforward, but will need to craft the HTTP chatter to/from the server. Those "<i>to evict Tom from the big brother house, text TOM to ...</i>" systems would be very easy to implement once this is done. The web page on the server would be responsible for the data processing once the SMS hase been off-loaded from the gateway.</li><li>Some kind of validation (password/encryption). <br /></li></ul><br />Software is stable but still evolving but for now it demonstrates a reasonably robust working solution. It has run continuously for over a year with no problems - in fact the only problems I did have were with a weak Vodafone signal that meant the M590 was constantly trying to register on the network. Recently went to a Virgin SIM on a £6 a month unlimited texts deal and it has never failed since.<br /><br />Software and circuit diagram below - there are numerous connectors for modules cheaply available on eBay - the whole thing should cost you less than £20 in bits. <br /><br />The LCD is currently unused (although a header is there) and rich logging is provided through the CH340G USB interface which connects to the console of the micromite. The idea being eventually that it becomes a self-contained module and an LCD display will provide status etc. There's no need to leave it plugged in to putty all the time (but I do coz I love logs).<br /><br /><br /><br /><b>Circuit Diagram</b> The M590 module has a dodgy voltage dropper in the form of a single diode, and the power rail is marked as +5V. It relies on the forward voltage of the 1N4001 to bring the power in line with the M590's working spec - a practice expressly forbidden in the documentation, but hey what do the Chinese care so long as they can sell stuff. This caused me lots of problems early on with the modem section resetting out-of-the-blue. I replaced the diode with a wire link (in the photo, between the SIM and M590) and drove it from the 3.3V - it is perfectly happy now it's working in accordance with the spec :o/ beware cheap modules I guess. I also modified the module by bringing the "EMERGPDOWN" pin of the M590 (effectively a reset) out to the header so I can reset the thing. Normally this isn't available on these modules and you have a power toggle signal that mimics the power button on a mobile... problem is because it is a toggle, you can never be certain of the state of the module. As I found out when it was running from 5v, you can get weird outages, toggle the power to try and resolve it and find you have actively turned the thing off (because it was actually on but not responding)... horrible arrangement. <br /><br /><a class="unknownlink" href="MMBasic..html" title="MMBasic."></a><img src="SMSGatewaySCHcc80.png?File=/MMBasic/SMSGatewaySCH.png" alt="Image" /><br /><br /><br /><br /><b>Completed working unit (yet to be cased nicely).</b> Power is from a 5V3A "wallwart", 5v for the relay module and LCD, everything else is 3.3v from a 3A DC-DC converter module which gives a juicy power rail - specifically for the GSM module which can draw up to 1A with a weak mobile signal and the ESP8266 can draw 280mA, so bags of power for everything.<br /><br /><a class="unknownlink" href="MMBasic..html" title="MMBasic."></a><img src="SMSGateway1c5ea.png?File=/MMBasic/SMSGateway1.png" alt="Image" /><br /><br /><br /><br /><b>Sending a text message from a web page...</b><br /><br /><a class="unknownlink" href="MMBasic..html" title="MMBasic."></a><img src="SMSGateway25dcf.png?File=/MMBasic/SMSGateway2.png" alt="Image" /><br /><br /><br /><br /><b>... received on the SMS Gateway API...</b> Output from the console log<br /><br /><a class="unknownlink" href="MMBasic..html" title="MMBasic."></a><img src="SMSGateway414b0.png?File=/MMBasic/SMSGateway4.png" alt="Image" /><br /><br /><br /><br /><b>...and the same text received on my mobile phone.</b><br /><br /><a class="unknownlink" href="MMBasic..html" title="MMBasic."></a><img src="SMSGateway3fee6.png?File=/MMBasic/SMSGateway3.png" alt="Image" /><br /><br /><br /><br /><b>Here is a procession of recieved SMS messages.</b> this shows a typical life cycle together with some power cycling.<br /><br /><a class="unknownlink" href="MMBasic..html" title="MMBasic."></a><img src="SMSGatewaytexts207f.png?File=/MMBasic/SMSGatewaytexts.png" alt="Image" /><br /><br /><br />Here is the source code... remember this is very specific to my application, you'll have to pick through it if you want to use it and add/remove any bits you like. Please use the discuss option to ask questions, that way everyone sees the thread and you will likely answer the same questions they have ;o)<br /><br /><pre>

'Preamble
	OPTION BASE 0
        CONST Mime$="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"
	CONST Secs=1000,Mins=Secs&#42;60,Hrs=Mins&#42;60
	CONST GSM=1,GSMRST=16,LAN=2,LANRST=2,RL1=15
	CONST GSMTRchg=30,PRchg=180,PCRchg=2,DnRmdr=5
	CONST WDTime=60000
	CONST q=chr$(34)

	CONST defHB="05&#58;59" ' time to send the daily heartbeat message , set to -1 to disable
	CONST defPA="8.8.8.8" ' an address to ping on the internet
	CONST defAMbl$="+4470123456789"  ' the "admin" mobile number
	CONST defIP="192.168.0.14" ' the unit's static IP address
	CONST defGW="192.168.0.1" ' its network gateway
	CONST defMS="255.255.255.0"' network mask
	CONST defAP="xyz" '  your wifi access point
	CONST defPW="bXkgcGFzc3dvcmQ&#61;&#61;" ' and its password in B64 encoded form
	CONST defTmpAlm=40 ' the enclosure temperature alarm point

	' 0-63 Flag CONSTs
	CONST SlaveSKT	=0
	CONST LANUp	=1
	CONST InetUp	=2
	CONST GSMUp	=3
	CONST GSMReg	=4

	CONST WDRst	=7

	CONST Conn	=8 'HTTP channels 0...
	'		=9
	'		=10
	'		=11
	'		=12 '... to 4

	CONST HBFg	=28
	CONST ConRFG	=29
	CONST ConPFG	=30
	CONST TOFg	=31

'H/W Init
	WATCHDOG OFF
	PIN(LANRST)=1&#58;SETPIN LANRST,DOUT
	PIN(GSMRST)=0&#58;SETPIN GSMRST,DOUT,OC
	PIN(RL1)=1&#58;SETPIN RL1,DOUT,OC

'S/W Init
	DIM STRING A$,B$,D$,HBTm LENGTH 5,MAC LENGTH 20
	DIM STRING PA$ LENGTH 15,IP$ LENGTH 15,GW$ LENGTH 15,MS$ LENGTH 15,AP$ LENGTH 32,PW$ LENGTH 32
	DIM STRING LNBuf$,CBuf$,Ver LENGTH 64,LANRxLN$,LANTxLN$,TC$ LENGTH 1,LL1$ LENGTH 16,LL2$ LENGTH 16
	DIM INTEGER FLAGS,h,m,C,Z,Chan,PTmr,PCt,RL1TMR
	DIM INTEGER LANf,GSMf,DSMSCt,OBSMSCt,IBSMSCt,Temp,TmpAlm
	DIM FLOAT x

	HBTm=defHB
	AMbl$=defAMbl$
	TmpAlm=defTmpAlm

	PA$=defPA
	IP$=defIP
	GW$=defGW
	MS$=defMS
	AP$=defAP
	PW$=B64Dec$(defPW)

	Ver="SMS Gateway V1.2 (C)2016,2017"

	CL Ver,0

	SetClock

	IF MM.WATCHDOG THEN FlagSet WDRst&#58;CL "&#42;&#42;&#42; RESTART FORCED BY WATCHDOG &#42;&#42;&#42;",0 ELSE FlagRes WDRst

	FLAGS=0&#58;FlagSet SlaveSKT

	TC$=" "&#58;a$=Replace$(Replace$(DS$(),"&#58;",""),"-","")
	LL2$= MID$(a$,3,6) + MID$(a$,10,4) + STRING$(6," ")
	BuildLCD

	CL "System coming up",0

'timer inits
	PTmr=PRchg
	GSMPollTMR=GSMTRchg

	PCt=1&#58;RL1TMR=-1

	CL "Starting LAN Interface",0
	TIMER=0
	Open "COM2&#58;9600,1024" As &#35;LAN
	ESP8266Reset
	FlagSet LANUp&#58;FlagSet InetUp
	CL "... LAN up in "+STR$(TIMER)+"mS",0

	CL "Starting GSM Interface",0
	Chan=TIMER
	Open "COM1&#58;9600,8192" As &#35;GSM
	M590Reset
	FlagSet GSMUp&#58;FlagSet GSMReg
	CL "... GSM up in "+STR$(TIMER-Chan)+"mS",0

	CL "Starting Core timer thread",0
	SETTICK 1&#42;Secs,CoreTMR,4

	CL "Boot took "+STR$(TIMER)+"mS",0

	GL GSMSend(AMbl$,"SMS Gateway has started")

	CL "System Running",0

	GetTemp

Main&#58;
	WATCHDOG=WDTime

	IF LEFT$(TIME$,5)=HBTm THEN
		IF FlagTest(HBFg)=0 THEN
			GL GSMSend(AMbl$,"SMS Gateway heartbeat. " + DATE$ + " " + TIME$)
			FlagSet HBFg
		END IF
	ELSE
		FlagRes HBFg
	END IF

	IF RL1TMR=0 then
		RL1TMR=-1
		FlagSet SlaveSKT
		PIN(RL1)=1
		A$="Slave socket power ON"
		CL A$,0
		GL GSMSend(AMbl$,A$)
	END IF

	IF PTmr&lt;=0 THEN
		PTmr=PRchg

		A$=ESP8266Exec$("AT+PING="+q+PA+q,4000,0)

		IF A$="OK" THEN
			IF FlagTest(InetUp)=0 THEN
				GL GSMSend(AMbl$,"I/Net UP")
			END IF
			FlagSet InetUp
			CL "I/Net connected OK",0
			LANf=0&#58;DSMSCt=0
			PCt=PCRchg
		ELSE
			FlagRes InetUp
			LANf=LANf+1&#58;IF LANf&gt;9 THEN LANf=9
			CL "I/Net Down",0
			PCt=PCt-1
			IF PCt=0 THEN
				GL GSMSend(AMbl$,"I/Net DOWN, please check")
			ELSE
				CL "... for "+STR$(ABS(PCt)&#42;PRchg),0
				x=ABS(PCt)/DnRmdr
				IF x=INT(x) AND x&gt;0 THEN
					DSMSCt=DSMSCt+1&#58;IF DSMSCt&gt;99 THEN DSMSCt=99
					GL GSMSend(AMbl$,"I/Net remains DOWN, please check")
				END IF
			END IF
		END IF

'convenient place
		GetTemp
		SetClock
		CL "Enclosure Temp " + str$(Temp)+"C",0

	END IF

	IF GSMPollTMR&lt;=0 THEN
		GSMPollTMR=GSMTRchg
		A$="AT+CREG?"
		A$=M590Exec$(A$,2,0,"+CREG&#58; 0,1")
		IF A$="T/O" OR A$="ERROR" THEN
			FlagRes GSMReg
			GSMf=GSMf+1&#58;IF GSMf&gt;9 THEN GSMf=9
			CL A$,0
			CL "GSM not registered",0
		ELSE
			FlagSet GSMReg
			GSMf=0
			CL A$,0
			CL "GSM registration OK",0
		END IF

		FlushIO(GSM)

'check recieved messages
		A$="AT+CMGL=4"
		CL A$,0
		PRINT&#35;GSM,A$
		PAUSE 500

		DO
			A$=GetIO$(GSM,2)
			IF A$&lt;&gt;"" then CL A$,0
			IF A$="OK" THEN EXIT DO

			IF INSTR(A$,"+CMGL&#58;") THEN 'envelope
				B$=GetIO$(GSM,2) 'message
				CL B$,0
				A$=Replace$(A$,CHR$(34),"")
				z=Split(A$,",")
				'    1       2          3       4    5       6
				'+CMGL&#58; 1,REC UNREAD,+447777777,,16/10/07,22&#58;11&#58;35+04

				IF SP$(2)="REC UNREAD" THEN
					IF RIGHT$(RTRim$(SP$(3)),13)=AMbl$ THEN
						SELECT CASE UCASE$(B$)
							CASE "AFGHANISTANBANANASTAND" ' magic message from admin mobile to activate the relay
								FlagRes SlaveSKT
								PIN(RL1)=0&#58;RL1TMR=10
								A$="Slave socket power OFF"
								CL A$,0
								GL GSMSend(AMbl$,A$)
							CASE "PING"
								GL GSMSend(AMbl$,"OK FLAGS="+RIGHT$(BIN$(FLAGS,8),8)+" "+STR$(Temp)+"C")
						END SELECT
					END IF
				END IF

			END IF
		LOOP

		A$="AT+CMGD=1,1"
		A$=M590Exec$(A$,2,0,"OK")
		FlushIO(GSM)
	END IF

'Console input
	A$=INKEY$
	DO WHILE A$&lt;&gt;""
		SELECT CASE ASC(A$)
			CASE 13
				IF CBuf$&lt;&gt;"" THEN CBuf$=UCASE$(CBuf$)&#58;FlagSet ConRFG
			CASE 0 TO 31
			CASE 127 TO 255
			CASE ELSE
				IF LEN(CBuf$)&lt;255 THEN 
					CBuf$=CBuf$+A$
				ELSE
					CL "Console buffer over-run",0&#58;CBuf$=""&#58;FlagRes ConRFG
				END IF
		END SELECT
		A$=INKEY$
	LOOP

	IF FlagTest(ConRFG)=1 THEN 'parse the commands
		FlagRes ConPFG
		args=Split(Trim$(CBuf$)," ")
		SELECT CASE SP$(1) ' individual verbs

			CASE "HELP"
				CL SP$(1),0
				CL "Console commands&#58;",0
				CL "  HELP   =This list.",0
				CL "  DEBUG  =Show internal flags etc.",0
				CL "  HEARTBEAT hh&#58;mm|-1  =Set/Disable daily Heartbeat SMS time (24H)",0
				CL "  ADMINPH +44&lt;num&gt;  =Set the Admin mobile No.",0
				CL "  NETWORK DHCP|STATIC &#91;&lt;ip&gt; &lt;mask&gt; &lt;gateway&gt;&#93; =Set the LAN IP Address",0
				CL "  PING &lt;ip&gt;  =Set the Internet test IP Address",0
				CL "",0
				CL "Current Settings&#58;",0
				CL "  Admin Phone No.  "+AMbl$
				CL "  Heartbeat SMS    "+HBTm
				CL "  IP,Gateway,Mask  "+IP$+" "+GW$+" "+MS$,0
				CL "  MAC address      "+MAC,0
				CL "  Inet Ping IP     "+PA$,0
				CL "",0
				CL "  Enclosure Temp   " + str$(Temp)+"C",0
				CL "  Temp alarm at    " + str$(TmpAlm)+"C",0
				CL "",0
				CL "Additional material&#58;",0
				CL "    Geoff Graham (MMBasic) and MicroMite.org (MicroMite)",0
				CL "",0

			CASE "DEBUG"
				CL SP$(1),0
				CL "FLAGS="+Bin$(FLAGS,32),0

			CASE "HEARTBEAT"
				IF args&lt;2 THEN
					FlagSet ConPFG
				ELSE
					IF SP$(2)="-1" then HBTm=SP$(2)&#58;CL "Daily heartbeat disabled",0&#58;GOTO HBTExit
					IF LEN(SP$(2))&lt;&gt;5 then
						FlagSet ConPFG
					ELSE
						z=VAL(LEFT$(SP$(2),2))
						IF z&lt;0 OR z&gt;23 THEN 'hours
							FlagSet ConPFG
						ELSE
							z=VAL(RIGHT$(SP$(2),2)) 'Mins
							IF z&lt;0 OR z&gt;59 THEN
								FlagSet ConPFG
							ELSE
								IF MID$(SP$(2),3,1)&lt;&gt;"&#58;" THEN 'seperator
									FlagSet ConPFG
								ELSE
									HBTm=SP$(2)
									CL "Daily heartbeat set &#58; "+SP$(2),0
								END IF
							END IF
						END IF
					END IF
				END IF

HBTExit&#58;
			CASE ELSE
				FlagSet ConPFG

		END SELECT

		IF FlagTest(ConPFG)=1 THEN
			CL "Malformed command&#58; "+CBuf$,0
		END IF

		CBuf$=""&#58;FlagRes ConRFG
	END IF

'Web API parsing

	LANRxLN$=GetIO$(LAN,1)
	IF LANRxLN$="" OR LANRxLN$="T/O" THEN GOTO Main

	CL LANRxLN$,0
	IF MID$(LANRxLN$,2,8)=",CONNECT" THEN
		Chan=VAL(LANRxLN$)
		IF Chan&gt;=0 AND Chan&lt;=4 THEN
			FlagSet Conn+Chan
			CL "Inbound connect channel "+STR$(Chan),0
			GOTO IPEXIT
		END IF
	END IF

	IF MID$(LANRxLN$,2,7)=",CLOSED" THEN
		Chan=VAL(LANRxLN$)
		IF Chan&gt;=0 AND Chan&lt;=4 THEN
			IF FlagTest(Conn+Chan)=0 THEN A$="Abnormally " ELSE A$=""
			CL "Closed channel "+STR$(Chan),0
			FlagRes Conn+Chan
			GOTO IPEXIT
		END IF
	END IF

	IF LEFT$(LANRxLN$,5)="+IPD," THEN
		
		DO&#58;a$=GetIO$(LAN,2)&#58;LOOP UNTIL a$="Connection&#58; Keep-Alive"
		
		Chan=VAL(MID$(LANRxLN$,6,1))
		IF Chan&gt;4 THEN GOTO IPDerrEXIT
		IF FlagTest(Conn+Chan)=0 THEN GOTO IPDerrEXIT 'channel not open
		
		z=INSTR(LANRxLN$,"&#58;GET /") '+IPD,0,nnn&#58;GET /smssend?tel=077?msg=XYZ HTTP/1.1
		IF z=0 THEN GOTO IPDerrEXIT
		LANRxLN$=MID$(LANRxLN$,z+6)
		
		z=INSTR(LANRxLN$," HTTP")
		IF z=0 THEN GOTO IPDerrEXIT
		LANRxLN$=LEFT$(LANRxLN$,z-1)

		args=Split(Replace$(LANRxLN$,"+"," "),"?")

		SELECT CASE SP$(1)
			CASE "smssend"
				IF args &lt;3 THEN GOTO IPDerrEXIT
				Tel$=""&#58;Msg$=""
				
				FOR n=2 TO args
					a$=Trim$(URLDecode$(MID$(sp$(n),5)))
					SELECT CASE LEFT$(ucase$(SP$(n)),4)
						CASE "TEL="
							Tel$=a$
						CASE "MSG="
							Msg$=a$
					END SELECT
				NEXT
				IF Tel$="" OR Msg$="" THEN GOTO IPDerrEXIT

				CL "O/B SMS "+Tel$+"&#58;"+Msg$,0
				z=GSMSend(Tel$,Msg$)
				IF z=0 THEN
					B$="OK&#58; Message Queued for sending"&#58;GOTO IPOKEXIT
				ELSE
					B$="ERROR&#58; Gateway failed to send message &#123;"+STR$(z)+"&#125;"
					GOTO IPOKEXIT
				END IF

			CASE "stat"
				'IF z=&gt;8 AND Z&lt;=11 THEN
				'other API calls go here...
				'z=INSTR(LANRxLN$,"&#58;GET /whatever?")
				'IF z&lt;&gt;0 THEN
				'etc...

				'	B$="OK&#58; STAT="+LL1$+LL2$
				'	GOTO IPOKEXIT

		END SELECT

		GOTO IPDerrEXIT 'default action IF we don't find an API call

	END IF

	GOTO IPEXIT

IPDerrEXIT&#58;
	B$="ERROR&#58; Malformed request &#123;"+LANRxLN$+"&#125;"

IPOKEXIT&#58;
	PRINT &#35;LAN,"AT+CIPSENDEX="+STR$(Chan)+",255"
	PAUSE 100

	PRINT&#35;LAN,B$+"\0"
	PAUSE 100

	PRINT&#35;LAN,"AT+CIPCLOSE="+STR$(Chan)
	FlagRes Conn+Chan

IPEXIT&#58;
	GOTO Main

'&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45; ESP8266 WiFi Modem SUBsys &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-
	SUB ESP8266Reset
		LOCAL STRING A$
		LOCAL INTEGER N
		FlagRes LANUp
		PULSE LANRST,10
		PAUSE 400

		LANExec "ATE0",2,0
		LANExec "AT+CWAUTOCONN=0",2,0
		LANExec "AT+CWMODE=1",2,0
		LANExec "AT+CWQAP",4,0
		LANExec "AT+RFVDD",2,0
		LANExec "AT+CWJAP="+q+AP$+q+","+q+PW$+q,10,1
		LANExec "AT+CIPSTA="+q+IP$+q+","+q+GW$+q+","+q+MS$+q,2,0
		LANExec "AT+CIFSR",2,0
		LANExec "AT+CWAUTOCONN=1",2,0
		LANExec "AT+CIPMUX=1",2,0
		LANExec "AT+CIPSERVER=1,19090",2,0

		LANTxLN$=""&#58;LANRxLN$=""

		FlagSet LANUp
	END SUB

	SUB LANExec(CM$,T,Suppress)
		LOCAL STRING A$
		A$=ESP8266Exec$(CM$,T,Suppress)
		IF Suppress&lt;2 THEN CL A$,0
	END SUB

	FUNCTION ESP8266Exec$(Com$,TimeOut,Obf)
		LOCAL STRING A$ LENGTH 1,LN$
		LOCAL INTEGER C

		CL Com$,obf
		PRINT &#35;LAN,Com$

		DO
			LN$=GetIO$(LAN,TimeOut)
			' get special values

			IF INSTR(LN$,"+CIFSR&#58;STAMAC,")&lt;&gt;0 THEN
				MAC=MID$(LN$,16)
				MAC=LEFT$(MAC,INSTR(MAC,CHR$(34))-1)
			END IF

			IF INSTR(LN$,"WIFI DISCONNECT") THEN FlagRes(LANUp)
			IF INSTR(LN$,"WIFI CONNECTED") THEN FlagSet(LANUp)

			IF LN$="T/O" THEN ESP8266Exec$="T/O"&#58;FlagRes LANUp&#58;EXIT DO
			IF LN$&lt;&gt;"" THEN
				IF Obf&lt;2 THEN CL "&#91;"+LN$+"&#93;",0
				IF LN$="OK" OR LN$="&gt;" OR LN$="SEND OK" THEN ESP8266Exec$=LN$&#58;EXIT DO
				IF INSTR(LN$,"ERROR") THEN ESP8266Exec$="ERROR &#91;"+LNBuf$+"&#93;"&#58;EXIT DO
			END IF
		LOOP

	END FUNCTION

'&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45; M590 GSM Modem SUBsys &#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-
	SUB M590Reset
		LOCAL STRING A$
		LOCAL INTEGER N

		PIN(GSMRST)=0 'can't use pulse because it should already be lo
		PAUSE 500 'BOOT is active LO and at least 300mS
		PIN(GSMRST)=1

		ClearTOTimer
		DO
			IF FlagTest(TOFg) THEN GOTO GSMFail
			A$=GetIO$(GSM,5)
			CL A$,0
		LOOP UNTIL A$="MODEM&#58;STARTUP"

		ClearTOTimer
		DO
			IF FlagTest(TOFg) THEN GOTO GSMFail
			A$=GetIO$(GSM,120)
			CL A$,0
		LOOP UNTIL A$="+PBREADY"
		FlushIO(GSM)

		GSMExec "ATE0",2,0,"OK" '(TURN OFF LOCAL ECHO)
		FlushIO(GSM)

		GSMExec "AT+CPAS",2,0,"+CPAS&#58; 0"
		IF FlagTest(TOFg) THEN GOTO GSMFail

		DO
			PRINT &#35;GSM,"AT+CREG?"
			DO&#58;A$=GetIO$(GSM,2)&#58;LOOP WHILE LEN(A$)=0
			CL A$,0
			IF FlagTest(TOFg) THEN GOTO CREGWait
			IF INSTR(A$,"+CREG&#58;") THEN
				IF INSTR(A$,"+CREG&#58; 0,1")=0 THEN ' registered?
					GOTO CREGWait
				ELSE
					CL "Registered on GSM network",0
					GSMf=0
					EXIT DO
				END IF
			END IF
CREGWait&#58;
			CL "Waiting for GSM network registration",0
			PAUSE 5000
			FlushIO(GSM)
			GSMf=1
		LOOP

		IF GSMf THEN GOTO GSMFail

		GSMf=0

		GSMExec "AT+ENPWRSAVE=0",2,0,"OK"
		IF FlagTest(TOFg) THEN GOTO GSMFail
		FlushIO(GSM)

		GSMExec "AT+COPS?",2,0,"OK"
		IF FlagTest(TOFg) THEN GOTO GSMFail
		FlushIO(GSM)

		GSMExec "AT+CSQ",2,0,"OK"
		IF FlagTest(TOFg) THEN GOTO GSMFail
		FlushIO(GSM)

		GSMExec "AT+XBANDSEL?",2,0,"OK"
		IF FlagTest(TOFg) THEN GOTO GSMFail
		FlushIO(GSM)

		GSMExec "AT+CCID?",2,0,"OK"
		IF FlagTest(TOFg) THEN GOTO GSMFail
		FlushIO(GSM)

		GSMExec "AT+CSCA?",2,0,"OK"
		IF FlagTest(TOFg) THEN GOTO GSMFail
		FlushIO(GSM)

		GSMExec "AT+CFUN?",2,0,"+CFUN&#58; 1,0"
		IF FlagTest(TOFg) THEN GOTO GSMFail
		FlushIO(GSM)

		GSMExec "AT+CPIN?",2,0,"+CPIN&#58; READY"
		IF FlagTest(TOFg) THEN GOTO GSMFail
		FlushIO(GSM)

		GSMExec "AT+CSMS?",2,0,"OK"
		IF FlagTest(TOFg) THEN GOTO GSMFail
		FlushIO(GSM)

		GSMExec "AT+CMGF=1",2,0,"OK"
		IF FlagTest(TOFg) THEN GOTO GSMFail
		FlushIO(GSM)

		GSMExec "AT+CSCS="+CHR$(34)+"GSM"+CHR$(34),2,0,"OK"
		IF FlagTest(TOFg) THEN GOTO GSMFail
		FlushIO(GSM)

		GSMExec "AT+CMGD=1,1",2,0,"OK"
		IF FlagTest(TOFg) THEN GOTO GSMFail
		FlushIO(GSM)

		EXIT SUB

GSMFail&#58;
		FlagRes GSMUp
		GSMf=1
		CL "... Failed to start in "+STR$(TIMER-Chan)+"mS",0
	END SUB

	SUB GSMExec(CM$,T,obf,Resp$)
		LOCAL STRING A$
		A$=M590Exec$(CM$,T,obf,Resp$)&#58;CL A$,0
	END SUB

	FUNCTION M590Exec$(Com$,TimeOut,obf,Resp$)
		LOCAL STRING A$ LENGTH 1,LN$,LNBuf$
		LOCAL INTEGER C,n,z

		CL Com$,obf
		z=Split(Resp$,"|")
		PRINT &#35;GSM,Com$
		StartTOTimer TimeOut

		DO
			IF FlagTest(TOFg) THEN M590Exec$="T/O &#91;"+LNBuf$+"&#93;"&#58;FlagRes GSMUp&#58;EXIT DO
			IF LOC(&#35;GSM)&lt;&gt;0 THEN
				A$=INPUT$(1,&#35;GSM)&#58;C=ASC(A$)
				SELECT CASE C
					CASE 13
						IF LN$&lt;&gt;"" THEN
							LNBuf$=LNBuf$+LN$
							CL "&#91;"+LNBuf$+"&#93;",0
							FOR n=1 TO z
								IF LN$=SP$(n) THEN M590Exec$=LN$&#58;EXIT DO
							NEXT
							IF INSTR(LN$,"ERROR") THEN M590Exec$="ERROR &#91;"+LNBuf$+"&#93;"&#58;FlagRes GSMUp&#58;EXIT DO
							LN$=""&#58;LNBuf$=""
						END IF
					CASE 0 TO 31
					CASE ELSE
						LN$=LN$+A$
				END SELECT
			END IF
		LOOP
		ClearTOTimer
		FlagSet GSMUp
	END FUNCTION

	FUNCTION GSMSend(t$,m$)
		LOCAL INTEGER n
		LOCAL STRING A$
		IF GSMf&lt;&gt;0 THEN GSMSend=10191&#58;EXIT FUNCTION
		a$="AT+CMGS="+chr$(34)+t$+CHR$(34)
		PRINT&#35;GSM,A$
		CL A$,0
		PAUSE 1000
		a$=LEFT$(m$,140)
		PRINT&#35;GSM,A$+CHR$(26);
		CL a$,0
		PAUSE 100
		DO
			A$=GetIO$(GSM,15)
			CL A$,0
			IF INSTR(A$,"+CMGS&#58;") THEN GSMSend=0&#58;EXIT FUNCTION
			IF A$="T/O" THEN EXIT DO
		LOOP
		GSMSend=10156
	END FUNCTION

	SUB GL(z as integer)
		IF z=0 then CL "SMS Send OK",0 ELSE CL "SMS Send Fail ("+STR$(z)+")",0
	END SUB
'&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;

	SUB CL(Com$,obf)
		SELECT CASE Obf
			CASE 0
				PRINT DS$();Com$
			CASE 1
				PRINT DS$();STRING$(20,"&#35;")
			CASE ELSE
		END SELECT
	END SUB

	FUNCTION GetIO$(io,TimeOut)
		LOCAL STRING a$,b$
		LOCAL INTEGER c
		StartTOTimer TimeOut
		DO
			IF FlagTest(TOFg) THEN GetIO$="T/O"&#58;EXIT DO
			IF LOC(&#35;io)&lt;&gt;0 THEN
				A$=INPUT$(1,&#35;io)&#58;C=ASC(A$)
				SELECT CASE C
					CASE 13
						GetIO$=b$&#58;EXIT DO
					CASE 0 TO 31
					CASE ELSE
						IF LEN(b$)+LEN(a$)&lt;255 THEN b$=b$+a$ ELSE b$=a$
				END SELECT
			END IF
		LOOP
		ClearTOTimer
	END FUNCTION

	SUB FlushIO(stream)
		LOCAL STRING A$
		DO WHILE LOC(&#35;stream)&lt;&gt;0
			PAUSE 50&#58;A$=INPUT$(LOC(&#35;stream),&#35;stream)&#58;PAUSE 50
		LOOP
	END SUB

	SUB CoreTMR
		PTmr=PTmr-1
		GSMPollTMR=GSMPollTMR-1
		RL1TMR=RL1TMR-1
		IF TC$="&#42;" THEN TC$=" " ELSE TC$="&#42;"
		BuildLCD
	END SUB

	SUB StartTOTimer(Timeout)
		FlagRes TOFg&#58;SETTICK TimeOut&#42;1000,SetTOFg,2
	END SUB

	SUB ClearTOTimer
		SETTICK 0,0,2&#58;FlagRes TOFg
	END SUB

	SUB SetTOFg
		FlagSet TOFg
	END SUB

	SUB BuildLCD
		LL1$="L" + STR$(LANf) + "G" + STR$(GSMf) + "S" + STR$(PIN(16)) + "O" + STR$(OBSMSCt,4,0,"0") + "I" + STR$(IBSMSCt,4,0,"0")
		LL2$=LEFT$(LL2$,10) + "	 " + TC$ + STR$(DSMSCt,2,0,"0")
		'PRINT LL1$&#58;PRINT LL2$&#58;PRINT
	END SUB

	FUNCTION DS$()
		LOCAL a$,b$
		DO&#58;a$=date$&#58;b$=time$&#58;LOOP WHILE a$&lt;&gt;date$ OR b$&lt;&gt;time$
		DS$=RIGHT$(a$,4)+MID$(a$,3,3)+"-"+LEFT$(a$,2)+" "+b$+" "
	END FUNCTION

	FUNCTION Replace$(a$,b$,c$)
		LOCAL INTEGER z
		LOCAL STRING x$,y$
		z=1
		DO
			z=INSTR(z,a$,b$)
			IF z=0 THEN EXIT DO
			x$=LEFT$(a$,z-1)&#58;y$=MID$(a$,z+LEN(b$))&#58;a$=x$+c$+y$&#58;z=LEN(x$)+LEN(c$)
		LOOP
		Replace$=a$
	END FUNCTION

	FUNCTION URLDecode$(a$)
		LOCAL INTEGER z
		LOCAL STRING b$,c$
		z=1
		DO
			z=INSTR(z,a$,"%")
			IF z=0 OR z=LEN(a$) THEN EXIT DO
			b$=MID$(a$,z,3)&#58;c$=CHR$(VAL("&amp;h"+MID$(b$,2)))&#58;a$=Replace$(a$,b$,c$)
		LOOP
		URLDecode$=a$
	END FUNCTION

	FUNCTION Trim$(a$)
		Trim$=LTrim$(RTrim$(a$))
	END FUNCTION

	FUNCTION LTrim$(a$)
		LOCAL INTEGER m
		FOR m=1 TO LEN(a$)
			IF NOT(MID$(a$,m,1)=" " OR MID$(a$,m,1)=CHR$(9)) THEN LTrim$=MID$(a$,m)&#58;EXIT FUNCTION
		NEXT
		LTrim$=""
	END FUNCTION

	FUNCTION RTrim$(a$)
		LOCAL INTEGER n
		FOR n=LEN(a$) TO 1 STEP -1
			IF NOT(MID$(a$,n,1)=" " OR MID$(a$,n,1)=CHR$(9)) THEN RTrim$=LEFT$(a$,n)&#58;EXIT FUNCTION
		NEXT
		RTrim$=""
	END FUNCTION

	FUNCTION Split(a$,b$)
		LOCAL INTEGER z,n,m
		ON ERROR SKIP
		ERASE SP$
		z=1&#58;n=0
		DO
			z=INSTR(z,a$,b$)
			IF z=0 THEN
				IF n=0 THEN
					DIM SP$(1)&#58;SP$(1)=a$&#58;Split=1&#58;EXIT FUNCTION
				ELSE
					EXIT DO
				END IF
			ELSE
				n=n+1&#58;z=z+LEN(b$)
			END IF
		LOOP

		m=n+1&#58;n=1
		DIM SP$(m)
		DO
			z=INSTR(1,a$,b$)
			IF z=0 THEN
				SP$(m)=a$&#58;EXIT DO
			ELSE
				SP$(n)=LEFT$(a$,z-1)&#58;a$=MID$(a$,z+LEN(b$))&#58;n=n+1
			END IF
		LOOP
		Split=m
	END FUNCTION

	SUB FlagSet(bit AS INTEGER)
		FLAGS=FLAGS OR (2^bit)
	END SUB

	SUB FlagRes(bit AS INTEGER)
		FLAGS=(FLAGS OR (2^bit)) XOR (2^bit)
	END SUB

	FUNCTION FlagTest(bit AS INTEGER) AS INTEGER
		FlagTest=ABS(SGN(FLAGS AND (2^bit)))
	END FUNCTION

	FUNCTION B64Dec$(x$)
		LOCAL INTEGER  w1,w2,w3,w4,n
		LOCAL STRING so$
		FOR n=1 TO LEN(x$) STEP 4
			w1=MD(MID$(x$,n,1))&#58;w2=MD(MID$(x$,n+1,1))&#58;w3=MD(MID$(x$,n+2,1))&#58;w4=MD(MID$(x$,n+3,1))
			IF w2&gt;=0 THEN so$=so$+CHR$(((w1&#42;4+INT(w2/16)) AND 255))
			IF w3&gt;=0 THEN so$=so$+CHR$(((w2&#42;16+INT(w3/4)) AND 255))
			IF w4&gt;=0 THEN so$=so$+CHR$(((w3&#42;64+w4) AND 255))
		NEXT
		B64Dec$=so$
	END FUNCTION

	FUNCTION MD(x$)
		IF LEN(x$)=0 THEN MD=-1 ELSE MD=INSTR(Mime$,x$)-1
	END FUNCTION

	SUB SetClock
		RTC GETTIME
	END SUB

	SUB GetTemp
		RTC GetReg 17,Temp
		IF Temp&gt;=TmpAlm THEN GL GSMSend(AMbl$,"Enclosure temperature alarm! Temp is " + str$(Temp)+"C Threshold is " + str$(TmpAlm)+"C")
	END SUB


</pre><br /><br /><br /><br /><br /><br /><br /><br /><br />
	</div>
	
	
	
	<div id="PageAttachmentsDiv" style="position: absolute; left: 10000px;">
		
    </div>
    
    <div id="AdminToolsDiv" style="position: absolute; left: 10000px;">
		
		
		
    </div>
    
    <script type="text/javascript">
    <!--
    	function __RepositionDiv(link, element) {
    		var absPos = __AbsolutePosition(link);
    		var elemAbsPos = __AbsolutePosition(element);

    		element.style["top"] = (absPos.top + absPos.height) + "px";
    		element.style["left"] = (absPos.left - (elemAbsPos.width - absPos.width)) + "px";
    		element.style["position"] = "absolute";
    	}

		// Hide attachments and admin tools divs
    	// This is needed because __RepositionDiv cannot calculate the width of the element when it's hidden
    	var __elem = document.getElementById("PageAttachmentsDiv");
    	if(document.getElementById("PageAttachmentsLink")) {
    		__RepositionDiv(document.getElementById("PageAttachmentsLink"), __elem);
    	}
    	__elem.style["display"] = "none";

    	__elem = document.getElementById("AdminToolsDiv");
    	if(document.getElementById("AdminToolsLink")) {
    		__RepositionDiv(document.getElementById("AdminToolsLink"), __elem);
    	}
    	__elem.style["display"] = "none";

    	__InitBCT();
    // -->
    </script>


                <div id="PageInternalFooterDiv"></div>
                <div id="MainFooterDiv">
                    <!-- Used for layout purposes only -->
                </div>
            </div>

        </div>
            
        <div id="FooterDiv">
             
        </div>

    </form>  
</body>

<!-- Mirrored from fruitoftheshed.com/MMBasic.Micromite-SMS-Text-Gateway.ashx?HL=mmbasic by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 09 Feb 2022 14:29:29 GMT -->
</html>
