

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html dir="ltr" xmlns="http://www.w3.org/1999/xhtml" >

<!-- Mirrored from fruitoftheshed.com/MMBasic.Print.aspx?Page=MMBasic.Modbus-CRC-uses-the-bit-by-bit-method by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 09 Feb 2022 12:21:40 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><title>
	Modbus CRC uses the bit by bit method - Fruit Of The Shed
</title><link rel="stylesheet" type="text/css" href="Themes/Print.css" /></head>
<body>
    <form name="frmPrint" method="post" action="http://fruitoftheshed.com/Print.aspx?NS=MMBasic&amp;Page=MMBasic.Modbus-CRC-uses-the-bit-by-bit-method" id="frmPrint">
<div>
<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="/wEPDwULLTIwMDg4Njc4MjcPZBYCAgEPZBYCAgEPFgIeBFRleHQFgRY8aDEgY2xhc3M9InBhZ2V0aXRsZSI+TW9kYnVzIENSQyB1c2VzIHRoZSBiaXQgYnkgYml0IG1ldGhvZDwvaDE+PHNtYWxsPk1vZGlmaWVkIG9uIDIwMTgvMTIvMTMgMDY6MDMgYnkgQmlsbCAmbWRhc2g7IENhdGVnb3JpemVkIGFzOiBDb21tdW5pY2F0aW9uczwvc21hbGw+PGJyIC8+PGJyIC8+PGI+SW50cm9kdWN0aW9uOjwvYj48YnIgLz5UaGlzIENSQyAoQ3ljbGljIFJlZHVuZGFuY3kgQ2hlY2spIGlzIGZvciB0aGUgTW9kYnVzIFJUVSBwcm90b2NvbCBhcyB1c2VkIGluIFJTMjMyIGFuZCBSUzQ4NSBjb21tdW5pY2F0aW9ucy4gVGhlIENSQyBpcyBhIDE2IGJpdCB3b3JkIHRoYXQgaXMgY2FsY3VsYXRlZCBmcm9tIGFsbCBvZiB0aGUgZGF0YSBpbiBhIG1lc3NhZ2UuIEl0IGNhbm5vdCBjb3JyZWN0IGFueSBkYXRhIGNvcnJ1cHRpb24gYnV0IGl0IHdpbGwgaW5kaWNhdGUgaWYgYSBtZXNzYWdlIGhhcyBiZWVuIGNvcnJ1cHRlZCBpbiBzb21lIHdheS4gVGhpcyBwcm9ncmFtIHVzZXMgdGhlIGJpdC1ieS1iaXQgbWV0aG9kIHRvIGNhbGN1bGF0ZSB0aGUgQ1JDLjxiciAvPjxiciAvPjxiPlBMRUFTRSBOT1RFOjwvYj48YnIgLz5BbHRob3VnaCB0aGlzIGlzIGEgTW9kYnVzIENSQyBpdCBpcyBpbiBubyB3YXkgcmVzdHJpY3RlZCB0byBiZSBvbmx5IHVzZWQgZm9yIHRoZSBNb2RidXMgcHJvdG9jb2wuIEFueSBtZXNzYWdlIHN0cnVjdHVyZSBjb25zaXN0aW5nIG9mIGEgc3RyZWFtIG9mIDgtYml0IGRhdGEgYnl0ZXMgY2FuIHV0aWxpc2UgaXQuIEZvciBleGFtcGxlOjxiciAvPk1zZyQgPSDigJxUaGUgcXVpY2sgYnJvd24gZm94IGp1bXBzIG92ZXIgdGhlIGxhenkgZG9n4oCdPGJyIC8+PGJyIC8+PGI+QWNrbm93bGVkZ2VtZW50czo8L2I+PGJyIC8+VGhpcyBmdW5jdGlvbiB3YXMgd3JpdHRlbiBieSB0d28gbWVtYmVycyBvZiBUaGUgQmFjayBTaGVkIGZvcnVtOjxiciAvPjxiciAvPjxiPlRhc3N5SmltPC9iPiB3cm90ZSB0aGUgTU1CYXNpYyB2ZXJzaW9uIG9mIHRoZSBmdW5jdGlvbi48YnIgLz48Yj5QaGlsMjM8L2I+IGNvbnZlcnRlZCBpdCB0byBhIHN0cmluZyBmdW5jdGlvbiB0byBtYWtlIGl0IG1vcmUgdXNlciBmcmllbmRseS48YnIgLz48YnIgLz5JIG1hZGUgYSBmZXcgdHdlYWtzIHRvIGltcHJvdmUgc3BlZWQuPGJyIC8+QmlsbCBNY0tpbmxleTxiciAvPjxiciAvPkFuIGV4YW1wbGUgYSBNb2RidXMgbWVzc2FnZSAoaW4gSGV4KSBjb3VsZCBsb29rIGxpa2U6PGJyIC8+PHByZT4NClNsYXZlIEFkZHJlc3MgICAgICAgICAgICAgMTgNCkZ1bmN0aW9uIENvZGUgICAgICAgICAgICAgMDMNClN0YXJ0IEFkZHJlc3MgKEhpKSAgICAgICAgMEINClN0YXJ0IEFkZHJlc3MgKExvKSAgICAgICAgQjkNCk51bWJlciBvZiBwb2ludHMgKEhpKSAgICAgMDANCk51bWJlciBvZiBwb2ludHMgKExvKSAgICAgMDENCkNSQyAoTG8pICAgICAgICAgICAgICAgICAgNTUNCkNSQyAoSGkpICAgICAgICAgICAgICAgICAgQzINCjwvcHJlPjxiciAvPk5vdGUgdGhhdCB0aGUgSGlnaC9Mb3cgb3JkZXIgb2YgYnl0ZXMgaW4gdGhlIENSQyBpcyB0aGUgcmV2ZXJzZSBvZiB0aGF0IHVzZWQgZm9yIHRoZSBkYXRhLiBJIGRvbuKAmXQga25vdyB3aHkuPGJyIC8+PGJyIC8+SW4gTU1CYXNpYyB3aXRob3V0IHRoZSBDUkMsIHRoYXQgbWVzc2FnZSB3b3VsZCBsb29rIGxpa2U6PGJyIC8+PGJyIC8+PHByZT5UeE1zZyQgPSBDSFIkKCZhbXA7SDE4KStDSFIkKCZhbXA7SDAzKStDSFIkKCZhbXA7SDBCKStDSFIkKCZhbXA7SEI5KStDSFIkKCZhbXA7SDAwKStDSFIkKCZhbXA7SDAxKTwvcHJlPjxiciAvPkFkZCB0aGUgQ1JDIHRvIHRoZSBtZXNzYWdlIGJ5OjxiciAvPjxiciAvPjxwcmU+VHhNc2ckID0gVHhNc2ckICsgQ3JjU3RyKFR4TXNnJCk8L3ByZT48YnIgLz5QZXJmb3JtaW5nIGEgQ1JDIGNoZWNrIG9uIGEgbWVzc2FnZSB0aGF0IGFscmVhZHkgaW5jbHVkZXMgYSB2YWxpZCBDUkMgd2lsbCBwcm9kdWNlIGEgJ0NSQycgb2YgJmgwMDAgc286PGJyIC8+Q2hlY2sgdGhlIHJlY2VpdmVkIG1lc3NhZ2UgKGVnIFJ4TXNnKSBieTo8YnIgLz48YnIgLz48cHJlPklGIENyY1N0cihSeE1zZyQpID0gQ0hSJCgwKSArIENIUiQoMCkgVEhFTiAnIENSQyBpcyBPSw0KJyBQcm9jZXNzIHRoZSByZXNwb25zZQ0KRUxTRQ0KJyBCYWQgQ1JDIC0gZG8gbm90aGluZyAtIGRvbid0IHJlc3BvbmQNCkVORCBJRjwvcHJlPjxiciAvPjxiPkFzc3VtcHRpb25zOjwvYj48YnIgLz5Ob25lPGJyIC8+PGJyIC8+PGI+VGhlIEZ1bmN0aW9uOjwvYj48YnIgLz48cHJlPg0KRlVOQ1RJT04gQ3JjU3RyKGEkKSBBUyBTVFJJTkcNCiAgTE9DQUwgRXJyb3JXb3JkJSA9ICZhbXA7SEZGRkYsIG4sIGosIExTQiBBUyBJTlRFR0VSDQogIEZPUiBuID0gMSBUTyBMRU4oQSQpDQogICAgQnl0ZVZhbCA9IEFTQyhNSUQkKGEkLCBuLCAxKSkNCiAgICBFcnJvcldvcmQlID0gKEVycm9yV29yZCUgQU5EICZhbXA7SEZGRkYpIFhPUiBBU0MoTUlEJChhJCwgbiwgMSkpDQogICAgRk9SIGogPSAxIFRPIDgNCiAgICAgIExTQiA9IEVycm9yV29yZCUgQU5EICZhbXA7SDAwMDENCiAgICAgIElGIExTQiA9IDEgVEhFTiBFcnJvcldvcmQlID0gRXJyb3JXb3JkJSAtIDENCiAgICAgIEVycm9yV29yZCUgPSBFcnJvcldvcmQlIC8gMg0KICAgICAgSUYgTFNCID0gMSBUSEVOIEVycm9yV29yZCUgPSBFcnJvcldvcmQlIFhPUiAmYW1wO0hBMDAxDQogICAgTkVYVCBqDQogIE5FWFQgbg0KICBDcmNTdHIgPSBDSFIkKEVycm9yV29yZCUgQU5EICZhbXA7SEZGKSArIENIUiQoRXJyb3JXb3JkJSAmZ3Q7Jmd0OyA4KQ0KRU5EIEZVTkNUSU9ODQo8L3ByZT48YnIgLz5kZK+2zrpuFcF6TCh5TK0jzznmUX+V" />
</div>

<div>

	<input type="hidden" name="__VIEWSTATEGENERATOR" id="__VIEWSTATEGENERATOR" value="03CF0AB7" />
</div>
        <h1 class="pagetitle">Modbus CRC uses the bit by bit method</h1><small>Modified on 2018/12/13 06:03 by Bill &mdash; Categorized as: Communications</small><br /><br /><b>Introduction:</b><br />This CRC (Cyclic Redundancy Check) is for the Modbus RTU protocol as used in RS232 and RS485 communications. The CRC is a 16 bit word that is calculated from all of the data in a message. It cannot correct any data corruption but it will indicate if a message has been corrupted in some way. This program uses the bit-by-bit method to calculate the CRC.<br /><br /><b>PLEASE NOTE:</b><br />Although this is a Modbus CRC it is in no way restricted to be only used for the Modbus protocol. Any message structure consisting of a stream of 8-bit data bytes can utilise it. For example:<br />Msg$ = “The quick brown fox jumps over the lazy dog”<br /><br /><b>Acknowledgements:</b><br />This function was written by two members of The Back Shed forum:<br /><br /><b>TassyJim</b> wrote the MMBasic version of the function.<br /><b>Phil23</b> converted it to a string function to make it more user friendly.<br /><br />I made a few tweaks to improve speed.<br />Bill McKinley<br /><br />An example a Modbus message (in Hex) could look like:<br /><pre>
Slave Address             18
Function Code             03
Start Address (Hi)        0B
Start Address (Lo)        B9
Number of points (Hi)     00
Number of points (Lo)     01
CRC (Lo)                  55
CRC (Hi)                  C2
</pre><br />Note that the High/Low order of bytes in the CRC is the reverse of that used for the data. I don’t know why.<br /><br />In MMBasic without the CRC, that message would look like:<br /><br /><pre>TxMsg$ = CHR$(&amp;H18)+CHR$(&amp;H03)+CHR$(&amp;H0B)+CHR$(&amp;HB9)+CHR$(&amp;H00)+CHR$(&amp;H01)</pre><br />Add the CRC to the message by:<br /><br /><pre>TxMsg$ = TxMsg$ + CrcStr(TxMsg$)</pre><br />Performing a CRC check on a message that already includes a valid CRC will produce a 'CRC' of &h000 so:<br />Check the received message (eg RxMsg) by:<br /><br /><pre>IF CrcStr(RxMsg$) = CHR$(0) + CHR$(0) THEN ' CRC is OK
' Process the response
ELSE
' Bad CRC - do nothing - don't respond
END IF</pre><br /><b>Assumptions:</b><br />None<br /><br /><b>The Function:</b><br /><pre>
FUNCTION CrcStr(a$) AS STRING
  LOCAL ErrorWord% = &amp;HFFFF, n, j, LSB AS INTEGER
  FOR n = 1 TO LEN(A$)
    ByteVal = ASC(MID$(a$, n, 1))
    ErrorWord% = (ErrorWord% AND &amp;HFFFF) XOR ASC(MID$(a$, n, 1))
    FOR j = 1 TO 8
      LSB = ErrorWord% AND &amp;H0001
      IF LSB = 1 THEN ErrorWord% = ErrorWord% - 1
      ErrorWord% = ErrorWord% / 2
      IF LSB = 1 THEN ErrorWord% = ErrorWord% XOR &amp;HA001
    NEXT j
  NEXT n
  CrcStr = CHR$(ErrorWord% AND &amp;HFF) + CHR$(ErrorWord% &gt;&gt; 8)
END FUNCTION
</pre><br />
    </form>
</body>

<!-- Mirrored from fruitoftheshed.com/MMBasic.Print.aspx?Page=MMBasic.Modbus-CRC-uses-the-bit-by-bit-method by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 09 Feb 2022 12:21:40 GMT -->
</html>
