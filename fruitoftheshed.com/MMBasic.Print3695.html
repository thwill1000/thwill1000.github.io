

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html dir="ltr" xmlns="http://www.w3.org/1999/xhtml" >

<!-- Mirrored from fruitoftheshed.com/MMBasic.Print.aspx?Page=MMBasic.Modbus-CRC-uses-the-table-lookup-method-for-speed by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 09 Feb 2022 12:21:46 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><title>
	Modbus CRC uses the table lookup method for speed - Fruit Of The Shed
</title><link rel="stylesheet" type="text/css" href="Themes/Print.css" /></head>
<body>
    <form name="frmPrint" method="post" action="http://fruitoftheshed.com/Print.aspx?NS=MMBasic&amp;Page=MMBasic.Modbus-CRC-uses-the-table-lookup-method-for-speed" id="frmPrint">
<div>
<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="/wEPDwULLTIwMDg4Njc4MjcPZBYCAgEPZBYCAgEPFgIeBFRleHQF5R88aDEgY2xhc3M9InBhZ2V0aXRsZSI+TW9kYnVzIENSQyB1c2VzIHRoZSB0YWJsZSBsb29rdXAgbWV0aG9kIGZvciBzcGVlZDwvaDE+PHNtYWxsPk1vZGlmaWVkIG9uIDIwMTkvMTEvMTEgMTc6NDYgYnkgQ2FwdGFpbkJvaW5nICZtZGFzaDsgQ2F0ZWdvcml6ZWQgYXM6IENvbW11bmljYXRpb25zPC9zbWFsbD48YnIgLz48YnIgLz48Yj5JbnRyb2R1Y3Rpb246PC9iPjxiciAvPlRoaXMgQ1JDIChDeWNsaWMgUmVkdW5kYW5jeSBDaGVjaykgaXMgZm9yIHRoZSBNb2RidXMgUlRVIHByb3RvY29sIGFzIHVzZWQgaW4gUlMyMzIgYW5kIFJTNDg1IGNvbW11bmljYXRpb25zLiBUaGUgQ1JDIGlzIGEgMTYgYml0IHdvcmQgdGhhdCBpcyBjYWxjdWxhdGVkIGZyb20gYWxsIG9mIHRoZSBkYXRhIGluIGEgbWVzc2FnZS4gSXQgY2Fubm90IGNvcnJlY3QgYW55IGRhdGEgY29ycnVwdGlvbiBidXQgaXQgd2lsbCBpbmRpY2F0ZSBpZiBhIG1lc3NhZ2UgaGFzIGJlZW4gY29ycnVwdGVkIGluIHNvbWUgd2F5LiBUaGlzIHByb2dyYW0gdXNlcyB0aGUgdGFibGUgbG9va3VwIG1ldGhvZCBmb3Igc3BlZWQuIEl0IHByb2Nlc3NlcyB0aGUgbWVzc2FnZSBieXRlLWJ5LWJ5dGUgcmF0aGVyIHRoYW4gdGhlIGJpdC1ieS1iaXQgbWV0aG9kIHdoaWNoIGlzIG1vcmUgdXN1YWwuIFRoaXMgcHJvZ3JhbSBnZW5lcmF0ZXMgdGhlIGxvb2t1cCB0YWJsZSBpbiBzb2Z0d2FyZSByYXRoZXIgdGhhbiBlbnRlcmluZyB0aGUgZGF0YSBpbnRvIHRoZSB0YWJsZSB2aWEgYSBzZXJpZXMgb2YgUkVBRC9EQVRBIHN0YXRlbWVudHMuIEl0IHJlcXVpcmVzIGFuIGludGVnZXIgdGFibGUgb2YgMjU2IHdvcmRzLjxiciAvPjxiciAvPjxiPlBMRUFTRSBOT1RFOjwvYj48YnIgLz5BbHRob3VnaCB0aGlzIGlzIGEgTW9kYnVzIENSQyBpdCBpcyBpbiBubyB3YXkgcmVzdHJpY3RlZCB0byBiZSBvbmx5IHVzZWQgZm9yIHRoZSBNb2RidXMgcHJvdG9jb2wuIEFueSBtZXNzYWdlIHN0cnVjdHVyZSBjb25zaXN0aW5nIG9mIGEgc3RyZWFtIG9mIDgtYml0IGRhdGEgYnl0ZXMgY2FuIHV0aWxpc2UgaXQuIEZvciBleGFtcGxlOjxiciAvPk1zZyQgPSDigJxUaGUgcXVpY2sgYnJvd24gZm94IGp1bXBzIG92ZXIgdGhlIGxhenkgZG9n4oCdPGJyIC8+PGJyIC8+QmlsbCBNY0tpbmxleTxiciAvPjxiciAvPkFuIGV4YW1wbGUgYSBNb2RidXMgbWVzc2FnZSAoaW4gSGV4KSBjb3VsZCBsb29rIGxpa2U6PGJyIC8+PHByZT4NClNsYXZlIEFkZHJlc3MgICAgICAgICAgICAgMTgNCkZ1bmN0aW9uIENvZGUgICAgICAgICAgICAgMDMNClN0YXJ0IEFkZHJlc3MgKEhpKSAgICAgICAgMEINClN0YXJ0IEFkZHJlc3MgKExvKSAgICAgICAgQjkNCk51bWJlciBvZiBwb2ludHMgKEhpKSAgICAgMDANCk51bWJlciBvZiBwb2ludHMgKExvKSAgICAgMDENCkNSQyAoTG8pICAgICAgICAgICAgICAgICAgNTUNCkNSQyAoSGkpICAgICAgICAgICAgICAgICAgQzINCjwvcHJlPjxiciAvPk5vdGUgdGhhdCB0aGUgSGlnaC9Mb3cgb3JkZXIgb2YgYnl0ZXMgaW4gdGhlIENSQyBpcyB0aGUgcmV2ZXJzZSBvZiB0aGF0IHVzZWQgZm9yIHRoZSBkYXRhLiBJIGRvbuKAmXQga25vdyB3aHkuPGJyIC8+PGJyIC8+SW4gTU1CYXNpYyB3aXRob3V0IHRoZSBDUkMsIHRoYXQgbWVzc2FnZSB3b3VsZCBsb29rIGxpa2U6PGJyIC8+PGJyIC8+PHByZT5UeE1zZyQgPSBDSFIkKCZhbXA7SDE4KStDSFIkKCZhbXA7SDAzKStDSFIkKCZhbXA7SDBCKStDSFIkKCZhbXA7SEI5KStDSFIkKCZhbXA7SDAwKStDSFIkKCZhbXA7SDAxKTwvcHJlPjxiciAvPkFkZCB0aGUgQ1JDIHRvIHRoZSBtZXNzYWdlIGJ5OjxiciAvPjxiciAvPjxwcmU+VHhNc2ckID0gVHhNc2ckICsgQ1JDMTYkKFR4TXNnJCk8L3ByZT48YnIgLz5QZXJmb3JtaW5nIGEgQ1JDIGNoZWNrIG9uIGEgbWVzc2FnZSB0aGF0IGFscmVhZHkgaW5jbHVkZXMgYSB2YWxpZCBDUkMgd2lsbCBwcm9kdWNlIGEgJ0NSQycgb2YgJmgwMDAgc286PGJyIC8+Q2hlY2sgdGhlIHJlY2VpdmVkIG1lc3NhZ2UgKGVnIFJ4TXNnKSBieTo8YnIgLz48YnIgLz48cHJlPklGIENSQzE2JChSeE1zZyQpID0gQ0hSJCgwKSArIENIUiQoMCkgVEhFTiAnIENSQyBpcyBPSw0KJyBQcm9jZXNzIHRoZSByZXNwb25zZQ0KRUxTRQ0KJyBCYWQgQ1JDIC0gRE8gbm90aGluZyAtIGRvbid0IHJlc3BvbmQNCkVORCBJRjwvcHJlPjxiciAvPlRvIHVzZSB0aGUgcHJvZ3JhbSwgaW5zZXJ0IHRoZSBjb2RlIGJlbG93IGludG8geW91ciBwcm9ncmFtLiBUaGUgc3Vicm91dGluZSBhbmQgZnVuY3Rpb24gY2FuIGJlIHBsYWNlZCBhbnl3aGVyZSwgcHJlZmVyYWJseSBhZnRlciB0aGUgbWFpbiBib2R5IG9mIHRoZSBwcm9ncmFtLiBUaGUgdGFibGUgRElNIHN0YXRlbWVudCBzaG91bGQgYmUgbmVhciB0aGUgdG9wIG9mIHRoZSBwcm9ncmFtIGFuZCB0aGUgJ2dlbkNSQ3RhYmxlJyBzdWJyb3V0aW5lIHNob3VsZCBiZSBvbmUgb2YgdGhlIGZpcnN0IGluc3RydWN0aW9ucyBhcyBwYXJ0IG9mIGFueSBpbml0aWFsaXNhdGlvbi48YnIgLz48YnIgLz48Yj5Bc3N1bXB0aW9uczo8L2I+PGJyIC8+VGhhdCB0aGUgZGVmYXVsdDogPGI+T1BUSU9OIEJBU0UgMDwvYj4gaXMgaW4gZm9yY2UuIElmIDxiPk9QVElPTiBCQVNFIDE8L2I+IGlzIHVzZWQgdGhlbiBzb21lIGNoYW5nZXMgd2lsbCBiZSBuZWVkZWQuPGJyIC8+PGJyIC8+PGI+VGhlIFByb2dyYW06PC9iPjxiciAvPjxwcmU+DQpESU0gSU5URUdFUiBjcmNfdGFibGUoMjU1KSAnIGxvb2t1cCB0YWJsZSBmb3IgQ1JDIGdlbmVyYXRpb24NCg0KZ2VuQ1JDdGFibGUgJyBnZW5lcmF0ZSB0aGUgbG9va3VwIHRhYmxlDQoNCg0KJyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1Ow0KJ2dlbmVyYXRlcyBhIGxvb2t1cCB0YWJsZSBmb3IgZmFzdCBjcmMgY2FsY3VsYXRpb24NClNVQiBnZW5DUkN0YWJsZQ0KTE9DQUwgaSUsIGolLCBrJSwgY3JjX2NvbnN0JSA9ICZhbXA7SEEwMDENCkZPUiBpJSA9IDAgVE8gMjU1DQogIGslID0gaSUmIzEyNTsmIzEyNTsNCiAgRk9SIGolID0gMSBUTyA4DQogICAgSUYgayUgQU5EIDEgVEhFTg0KICAgICAgayUgPSBrJSAmZ3Q7Jmd0OyAxDQogICAgICBrJSA9IGslIFhPUiBjcmNfY29uc3QlDQogICAgRUxTRQ0KICAgICAgayUgPSBrJSAmZ3Q7Jmd0OyAxDQogICAgRU5EIElGDQogIE5FWFQgaiUNCiBjcmNfdGFibGUoaSUpPWslDQpORVhUIGklDQpFTkQgU1VCDQonDQonIHJldHVybnMgdGhlIENSQyBhcyBhIHN0cmluZw0KRlVOQ1RJT04gQ1JDMTYkKGEkKQ0KICBMT0NBTCBDUkMlID0gJmFtcDtIRkZGRiwgbiUNCiAgRk9SIG4lID0gMSBUTyBMRU4oYSQpDQogICAgQ1JDJSA9IChDUkMlICZndDsmZ3Q7IDgpIFhPUiBjcmNfdGFibGUoQ1JDJSBYT1IgQVNDKE1JRCQoYSQsIG4lLCAxKSkgQU5EICZhbXA7SEZGKQ0KICBORVhUIG4lDQogIENSQzE2JCA9IENIUiQoQ1JDJSBBTkQgJmFtcDtIRkYpICsgQ0hSJCgoQ1JDJSZndDsmZ3Q7OCkgQU5EICZhbXA7SEZGKQ0KRU5EIEZVTkNUSU9ODQonJiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7JiM0NTsmIzQ1OyYjNDU7LQ0KPC9wcmU+ZGSeVVwGK+NVZi3K3cxWq/Lq0ybG2w==" />
</div>

<div>

	<input type="hidden" name="__VIEWSTATEGENERATOR" id="__VIEWSTATEGENERATOR" value="03CF0AB7" />
</div>
        <h1 class="pagetitle">Modbus CRC uses the table lookup method for speed</h1><small>Modified on 2019/11/11 17:46 by CaptainBoing &mdash; Categorized as: Communications</small><br /><br /><b>Introduction:</b><br />This CRC (Cyclic Redundancy Check) is for the Modbus RTU protocol as used in RS232 and RS485 communications. The CRC is a 16 bit word that is calculated from all of the data in a message. It cannot correct any data corruption but it will indicate if a message has been corrupted in some way. This program uses the table lookup method for speed. It processes the message byte-by-byte rather than the bit-by-bit method which is more usual. This program generates the lookup table in software rather than entering the data into the table via a series of READ/DATA statements. It requires an integer table of 256 words.<br /><br /><b>PLEASE NOTE:</b><br />Although this is a Modbus CRC it is in no way restricted to be only used for the Modbus protocol. Any message structure consisting of a stream of 8-bit data bytes can utilise it. For example:<br />Msg$ = “The quick brown fox jumps over the lazy dog”<br /><br />Bill McKinley<br /><br />An example a Modbus message (in Hex) could look like:<br /><pre>
Slave Address             18
Function Code             03
Start Address (Hi)        0B
Start Address (Lo)        B9
Number of points (Hi)     00
Number of points (Lo)     01
CRC (Lo)                  55
CRC (Hi)                  C2
</pre><br />Note that the High/Low order of bytes in the CRC is the reverse of that used for the data. I don’t know why.<br /><br />In MMBasic without the CRC, that message would look like:<br /><br /><pre>TxMsg$ = CHR$(&amp;H18)+CHR$(&amp;H03)+CHR$(&amp;H0B)+CHR$(&amp;HB9)+CHR$(&amp;H00)+CHR$(&amp;H01)</pre><br />Add the CRC to the message by:<br /><br /><pre>TxMsg$ = TxMsg$ + CRC16$(TxMsg$)</pre><br />Performing a CRC check on a message that already includes a valid CRC will produce a 'CRC' of &h000 so:<br />Check the received message (eg RxMsg) by:<br /><br /><pre>IF CRC16$(RxMsg$) = CHR$(0) + CHR$(0) THEN ' CRC is OK
' Process the response
ELSE
' Bad CRC - DO nothing - don't respond
END IF</pre><br />To use the program, insert the code below into your program. The subroutine and function can be placed anywhere, preferably after the main body of the program. The table DIM statement should be near the top of the program and the 'genCRCtable' subroutine should be one of the first instructions as part of any initialisation.<br /><br /><b>Assumptions:</b><br />That the default: <b>OPTION BASE 0</b> is in force. If <b>OPTION BASE 1</b> is used then some changes will be needed.<br /><br /><b>The Program:</b><br /><pre>
DIM INTEGER crc_table(255) ' lookup table for CRC generation

genCRCtable ' generate the lookup table


'&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;
'generates a lookup table for fast crc calculation
SUB genCRCtable
LOCAL i%, j%, k%, crc_const% = &amp;HA001
FOR i% = 0 TO 255
  k% = i%&#125;&#125;
  FOR j% = 1 TO 8
    IF k% AND 1 THEN
      k% = k% &gt;&gt; 1
      k% = k% XOR crc_const%
    ELSE
      k% = k% &gt;&gt; 1
    END IF
  NEXT j%
 crc_table(i%)=k%
NEXT i%
END SUB
'
' returns the CRC as a string
FUNCTION CRC16$(a$)
  LOCAL CRC% = &amp;HFFFF, n%
  FOR n% = 1 TO LEN(a$)
    CRC% = (CRC% &gt;&gt; 8) XOR crc_table(CRC% XOR ASC(MID$(a$, n%, 1)) AND &amp;HFF)
  NEXT n%
  CRC16$ = CHR$(CRC% AND &amp;HFF) + CHR$((CRC%&gt;&gt;8) AND &amp;HFF)
END FUNCTION
'&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;&#45;-
</pre>
    </form>
</body>

<!-- Mirrored from fruitoftheshed.com/MMBasic.Print.aspx?Page=MMBasic.Modbus-CRC-uses-the-table-lookup-method-for-speed by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 09 Feb 2022 12:21:46 GMT -->
</html>
